<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insiden & Pelanggaran â€” Sistem PDP PT Atri Pasifik</title>
    <link rel="stylesheet" href="style-pdp.css">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><img src="logo-atri.png" alt="AP"
                        onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\'font-size:16px;font-weight:800;color:#1B2B6B\'>AP</span>'">
                </div>
                <div class="sidebar-brand">
                    <h3>Sistem PDP</h3><span>PT Atri Pasifik</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-title">Menu Utama</div>
                <a class="nav-item" href="dashboard.html"><span class="nav-icon">ğŸ“Š</span> Dashboard</a>
                <a class="nav-item" href="inventaris.html"><span class="nav-icon">ğŸ—‚ï¸</span> Inventaris Data</a>
                <a class="nav-item" href="consent.html"><span class="nav-icon">âœ…</span> Manajemen Consent</a>
                <a class="nav-item" href="dsr.html"><span class="nav-icon">ğŸ‘¤</span> Hak Subjek Data</a>
                <a class="nav-item" href="permintaan.html"><span class="nav-icon">ğŸ“</span> Permintaan Internal</a>
                <div class="nav-section-title">Kepatuhan</div>
                <a class="nav-item" href="dpia.html"><span class="nav-icon">âš ï¸</span> Penilaian Risiko (DPIA)</a>
                <a class="nav-item active" href="insiden.html"><span class="nav-icon">ğŸš¨</span> Insiden &
                    Pelanggaran</a>
                <div class="nav-section-title">Administrasi</div>
                <a class="nav-item" href="dokumen.html"><span class="nav-icon">ğŸ“„</span> Dokumen & Kebijakan</a>
                <a class="nav-item" href="audit.html"><span class="nav-icon">ğŸ“‹</span> Audit Trail</a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="sidebarUserAvatar">A</div>
                    <div class="user-meta">
                        <h4 id="sidebarUserName">Admin PDP</h4><span id="sidebarUserRole">DPO</span>
                    </div>
                    <button onclick="logout()"
                        style="margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:18px;">ğŸšª</button>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-title">
                    <h2>Insiden & Pelanggaran Data</h2>
                    <p>Pelaporan dan penanganan insiden keamanan data Â· Pasal 46â€“47 UU PDP No. 27/2022</p>
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-danger" onclick="openModal('modalLaporInsiden')">ğŸš¨ Laporkan Insiden</button>
                </div>
            </header>

            <div class="page-content">
                <div class="alert-strip danger" style="margin-bottom:20px;">
                    ğŸš¨ Sesuai <strong>Pasal 46 UU PDP</strong>, setiap insiden kebocoran data WAJIB dilaporkan ke
                    <strong>Komnas PDP dalam 14 hari</strong> dan subjek data yang terdampak <strong>dalam 14
                        hari</strong>.
                </div>

                <div class="stats-grid" style="grid-template-columns:repeat(4,1fr); margin-bottom:24px;">
                    <div class="stat-card red">
                        <div class="stat-icon red">âš ï¸</div>
                        <div class="stat-value" id="incAktif">0</div>
                        <div class="stat-label">Insiden Aktif</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-icon orange">ğŸ”</div>
                        <div class="stat-value" id="incInvestigasi">0</div>
                        <div class="stat-label">Investigasi</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon green">âœ…</div>
                        <div class="stat-value" id="incSelesai">0</div>
                        <div class="stat-label">Tertangani</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon blue">ğŸ‘¥</div>
                        <div class="stat-value" id="incSubjek">0</div>
                        <div class="stat-label">Subjek Terdampak</div>
                    </div>
                </div>

                <div class="card" style="padding:0;">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Judul Insiden</th>
                                    <th>Jenis</th>
                                    <th>Tgl Kejadian</th>
                                    <th>Dampak</th>
                                    <th>Subjek Terdampak</th>
                                    <th>Lapor Komnas</th>
                                    <th>Status</th>
                                    <th>Detail</th>
                                </tr>
                            </thead>
                            <tbody id="insidenTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Laporkan Insiden -->
    <div class="modal-overlay" id="modalLaporInsiden">
        <div class="modal" style="max-width:680px;">
            <div class="modal-header">
                <div class="modal-icon danger">ğŸš¨</div>
                <div>
                    <div class="modal-title">Laporan Insiden Keamanan Data</div>
                    <div class="modal-subtitle">Pasal 46â€“47 UU PDP No. 27/2022</div>
                </div>
                <button class="modal-close" onclick="closeModal('modalLaporInsiden')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Judul Insiden <span
                            class="required">*</span></label><input type="text" id="inc_judul"
                        class="form-control no-icon" placeholder="Ringkasan singkat insiden"></div>
                <div class="grid-2">
                    <div class="form-group"><label class="form-label">Jenis Insiden <span
                                class="required">*</span></label>
                        <select id="inc_jenis" class="form-control form-select no-icon">
                            <option>Kebocoran Data</option>
                            <option>Akses Tidak Sah</option>
                            <option>Kehilangan Perangkat</option>
                            <option>Serangan Siber</option>
                            <option>Kesalahan Internal</option>
                            <option>Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Tingkat Dampak <span
                                class="required">*</span></label>
                        <select id="inc_dampak" class="form-control form-select no-icon">
                            <option value="RENDAH">Rendah</option>
                            <option value="SEDANG">Sedang</option>
                            <option value="TINGGI">Tinggi</option>
                            <option value="KRITIS">Kritis</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Deskripsi Lengkap <span
                            class="required">*</span></label><textarea id="inc_desc" class="form-control no-icon"
                        rows="3" placeholder="Jelaskan kronologi dan detail insiden..."></textarea></div>
                <div class="grid-2">
                    <div class="form-group"><label class="form-label">Tanggal Kejadian <span
                                class="required">*</span></label><input type="date" id="inc_tgl"
                            class="form-control no-icon"></div>
                    <div class="form-group"><label class="form-label">Jumlah Subjek Terdampak</label><input
                            type="number" id="inc_subjek" class="form-control no-icon" min="0" placeholder="0"
                            value="0"></div>
                </div>
                <div class="form-group"><label class="form-label">Tindakan yang Sudah Diambil</label><textarea
                        id="inc_tindakan" class="form-control no-icon" rows="2"
                        placeholder="Langkah-langkah mitigasi yang sudah dilakukan..."></textarea></div>
                <div class="form-group">
                    <label class="form-label">Laporan ke Komnas PDP?</label>
                    <select id="inc_lapor" class="form-control form-select no-icon">
                        <option value="TIDAK">Belum / Tidak Perlu</option>
                        <option value="YA">Ya â€” Sudah Dilaporkan</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalLaporInsiden')">Batal</button>
                <button class="btn btn-danger" onclick="tambahInsiden()">ğŸš¨ Simpan Laporan Insiden</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Detail Insiden -->
    <div class="modal-overlay" id="modalDetailInsiden">
        <div class="modal" style="max-width:560px;">
            <div class="modal-header">
                <div class="modal-icon danger">ğŸš¨</div>
                <div>
                    <div class="modal-title" id="detailInsidenTitle">Detail Insiden</div>
                    <div class="modal-subtitle" id="detailInsidenId"></div>
                </div>
                <button class="modal-close" onclick="closeModal('modalDetailInsiden')">âœ•</button>
            </div>
            <div class="modal-body" id="detailInsidenBody"></div>
            <div class="modal-footer"><button class="btn btn-outline"
                    onclick="closeModal('modalDetailInsiden')">Tutup</button></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <script src="app.js"></script>
    <script>
        function renderInsiden() {
            const data = JSON.parse(localStorage.getItem('pdp_insiden') || '[]');
            document.getElementById('incAktif').textContent = data.filter(d => d.status !== 'SELESAI').length;
            document.getElementById('incInvestigasi').textContent = data.filter(d => d.status === 'INVESTIGASI').length;
            document.getElementById('incSelesai').textContent = data.filter(d => d.status === 'SELESAI').length;
            document.getElementById('incSubjek').textContent = data.reduce((s, d) => s + (d.subjekTerdampak || 0), 0);

            document.getElementById('insidenTable').innerHTML = data.map(d => `
      <tr>
        <td><code style="font-size:11px;background:var(--bg);padding:2px 6px;border-radius:4px;">${d.id}</code></td>
        <td><div class="td-name">${d.judul}</div><div class="td-meta">${d.jenis}</div></td>
        <td><span class="badge badge-default">${d.jenis}</span></td>
        <td class="td-meta">${formatDate(d.tglKejadian)}</td>
        <td>${statusBadge(d.dampak)}</td>
        <td style="font-weight:700; color:${d.subjekTerdampak > 100 ? 'var(--danger)' : 'var(--text-primary)'};">${d.subjekTerdampak || 0} orang</td>
        <td>${d.laporKomnas === 'YA' ? '<span class="badge badge-success">âœ… Dilaporkan</span>' : '<span class="badge badge-danger">âŒ Belum</span>'}</td>
        <td>${statusBadge(d.status)}</td>
        <td><button class="btn btn-outline btn-sm" onclick="showDetailInsiden('${d.id}')">ğŸ“‹ Detail</button></td>
      </tr>
    `).join('') || `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸš¨</div><h4>Tidak ada insiden tercatat</h4></div></td></tr>`;
        }

        function tambahInsiden() {
            const judul = document.getElementById('inc_judul').value.trim();
            const desc = document.getElementById('inc_desc').value.trim();
            const tgl = document.getElementById('inc_tgl').value;
            if (!judul || !desc || !tgl) { showToast('Form Tidak Lengkap', 'Isi semua field wajib', 'error'); return; }
            const data = JSON.parse(localStorage.getItem('pdp_insiden') || '[]');
            const d = {
                id: generateId('INC'), judul, jenis: document.getElementById('inc_jenis').value,
                deskripsi: desc, dampak: document.getElementById('inc_dampak').value,
                tglKejadian: tgl, tglDiketahui: new Date().toISOString().split('T')[0],
                status: 'PROSES', subjekTerdampak: parseInt(document.getElementById('inc_subjek').value) || 0,
                laporKomnas: document.getElementById('inc_lapor').value,
                tglLapor: document.getElementById('inc_lapor').value === 'YA' ? new Date().toISOString().split('T')[0] : null,
                tindakan: document.getElementById('inc_tindakan').value || '-'
            };
            data.unshift(d);
            localStorage.setItem('pdp_insiden', JSON.stringify(data));
            addAuditLog('INSIDEN_LAPOR', `Insiden baru ${d.id}: ${judul} â€” dampak: ${d.dampak}`);
            closeModal('modalLaporInsiden');
            renderInsiden();
            showToast('Insiden Dilaporkan', `${d.id} berhasil disimpan. Tindak lanjut segera!`, d.dampak === 'KRITIS' ? 'error' : 'warning');
        }

        function showDetailInsiden(id) {
            const data = JSON.parse(localStorage.getItem('pdp_insiden') || '[]');
            const d = data.find(x => x.id === id);
            document.getElementById('detailInsidenTitle').textContent = d.judul;
            document.getElementById('detailInsidenId').textContent = d.id + ' Â· ' + d.jenis;
            document.getElementById('detailInsidenBody').innerHTML = `
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
        <div><div class="text-muted">Status</div><div style="margin-top:3px;">${statusBadge(d.status)}</div></div>
        <div><div class="text-muted">Tingkat Dampak</div><div style="margin-top:3px;">${statusBadge(d.dampak)}</div></div>
        <div><div class="text-muted">Tanggal Kejadian</div><div class="font-bold" style="margin-top:3px;">${formatDate(d.tglKejadian)}</div></div>
        <div><div class="text-muted">Diketahui Pada</div><div class="font-bold" style="margin-top:3px;">${formatDate(d.tglDiketahui)}</div></div>
        <div><div class="text-muted">Subjek Terdampak</div><div class="font-bold" style="margin-top:3px;color:var(--danger);">${d.subjekTerdampak} orang</div></div>
        <div><div class="text-muted">Lapor Komnas PDP</div><div style="margin-top:3px;">${d.laporKomnas === 'YA' ? '<span class="badge badge-success">âœ… Dilaporkan</span>' : '<span class="badge badge-danger">âŒ Belum</span>'}</div></div>
      </div>
      <div class="text-muted">Deskripsi</div>
      <div style="padding:10px; background:var(--bg); border-radius:8px; font-size:13px; margin-top:6px;">${d.deskripsi}</div>
      <div class="text-muted" style="margin-top:14px;">Tindakan yang Diambil</div>
      <div style="padding:10px; background:var(--bg); border-radius:8px; font-size:13px; margin-top:6px;">${d.tindakan}</div>
    `;
            openModal('modalDetailInsiden');
        }

        document.addEventListener('DOMContentLoaded', () => { requireAuth(); renderInsiden(); });
    </script>
</body>

</html>